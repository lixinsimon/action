<script language='javascript' src="{$_W['yuming']}/gongyong/js/haibao/designer.js"></script>
<script language='javascript' src="{$_W['yuming']}/gongyong/js/haibao/jquery.contextMenu.js"></script>
<link href="{$_W['yuming']}/gongyong/js/haibao/jquery.contextMenu.css" rel="stylesheet">
<form action="" method="post" class="form-horizontal" role="form">
	<input type="hidden" name="c" value="tijiao"/>
	<div class="form-group">
		<label class="col-sm-2 control-label"><span class="text-danger">*</span>海报名称</label>
		<div class="col-sm-10">
			<input type="text" name="ming" class="form-control" value="{php echo  $hb['ming']}">
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">海报类型</label>
		<div class="col-sm-10">
			<div class="radio-inline i-checks">
				<label><input type="radio" name="leixing" {if $hb['leixing']==1 }checked{/if} value="1"><i></i>关注海报 </label>
			</div>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label"><span class="text-danger">*</span>生成二维码关键词</label>
		<div class="col-sm-10">
			<input type="text" class="form-control" value="{$hb['guanjianci']}" name="guanjianci">
			<span class="help-block m-b-none">如果是商品海报 ，回复关键词是 关键词+商品ID</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">是否默认</label>
		<div class="col-sm-10">
			<div class="radio-inline i-checks">
				<label><input type="radio" name="moren" value="1" {if $hb['moren']==1}checked="checked"{/if}><i></i>是</label>
			</div>
			<div class="radio-inline i-checks">
				<label><input type="radio" name="moren" value="0" {if $hb['moren']==0}checked="checked"{/if}><i></i>否</label>
			</div>
			<span class="help-block m-b-none">是否是海报类型的默认设置，一种海报只能一个默认设置</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label"><span class="text-danger">*</span>海报设计</label>
		<div class="col-sm-10">
		    {mb 'biaoqian/haibao_tu_shiji'}
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">生成等待文字</label>
		<div class="col-sm-10">
			<textarea style="height: 80px;" class="form-control" name="dengdaitishi">{$hb['dengdaitishi']}</textarea>
			<span class="help-block m-b-none">例如：您的专属海报正在拼命生成中，请等待片刻···</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">开放权限</label>
		<div class="col-sm-10">
			<div class="radio-inline i-checks">
				<label><input type="radio" name="kaifang" value="1" {if $hb['kaifang']==1}checked="checked"{/if}><i></i>允许</label>
			</div>
			<div class="radio-inline i-checks">
				<label><input type="radio" name="kaifang" value="0" {if $hb['kiafang']==0}checked="checked"{/if}><i></i>不允许</label>
			</div>
			<span class="help-block m-b-none">是否允许非创客生成自己的海报</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label"><span class="text-danger">*</span>未开放时候的提示</label>
		<div class="col-sm-10">
			<input type="text" class="form-control" value="{$hb['bukaifangtishi']}" name="bukaifangtishi">
			<span class="help-block m-b-none">例如：您还不是我们的创客，去努力成为创客，拥有你的专属海报吧！</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label"><span class="text-danger">*</span>未开放时候的说明链接</label>
		<div class="col-sm-10">
			<input type="text" class="form-control" value="{$hb['bukaifangurl']}" name="bukaifangurl">
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label"><span class="text-danger">*</span>推送标题</label>
		<div class="col-sm-10">
			<input type="text" class="form-control" value="{php echo $hb['tuisong']['biaoti']}" name="tuisong[biaoti]">
			<span class="help-block m-b-none">如果设置为空，则不推送内容</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group" style="margin-right:0px;">
		<label class="col-sm-2 control-label">推送封面</label>
		<div class="col-sm-10">
			{php echo ShangTu('tuisong[tu]',$hb['tuisong']['tu'])}
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">推送描述</label>
		<div class="col-sm-10">
			<textarea style="height: 80px;" class="form-control" name="tuisong[miaoshu]">{php echo $hb['tuisong']['miaoshu']}</textarea>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">推送链接</label>
		<div class="col-sm-10">
			<input type="text" class="form-control" value="{php echo $hb['tuisong']['url']}" name="tuisong[url]">
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">推荐人获得</label>
		<div class="col-sm-10">
			<div class="input-group">
				<input type="text" name="song[jifen]" class="form-control" value="{php echo $hb['song']['jifen']}">
				<span class="input-group-addon">积分</span>
				<input type="text" name="song[jin_e]" class="form-control" value="{php echo $hb['song']['jin_e']}">
				<span class="input-group-addon">元现金</span>				
			</div>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">奖励现金方式</label>
		<div class="col-sm-10">
			<div class="radio-inline i-checks">
				<label><input type="radio" name="song[dakuanfangshi]" {if $hb['song']['dakuanfangshi'] =='yu_e' }checked="checked"{/if} value="yu_e"><i></i>余额</label>
			</div>
			<div class="radio-inline i-checks">
				<label><input type="radio" name="song[dakuanfangshi]" {if $hb['song']['dakuanfangshi'] =='weixin' }checked="checked"{/if} value="weixin" ><i></i>微信钱包</label>
			</div>
			<span class="help-block m-b-none">如果奖励现金，是打到零钱包还是余额( 打到零钱包需要微信支付，并在后台上传证书)</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">通知模板消息ID（任务处理通知）</label>
		<div class="col-sm-10">
			<input type="text" name="tongzhi[mobanid]" class="form-control" value="{$hb['tongzhi']['mobanid']}">
			<span class="help-block m-b-none">公众平台模板消息ID:  OPENTM200605630，如果不填写，则使用客服消息发送通知</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">推荐者通知</label>
		<div class="col-sm-10">
			<input type="text" name="tongzhi[tuijianren]" class="form-control" value="{$hb['tongzhi']['tuijianren']}">
			<span class="help-block">例如：[nicheng] 通过您的二维码关注了公众号! 获得了 [jifen] 个积分,[jin_e]元奖励!</span>
			<!--<span class="help-block m-b-none">[nicheng] 为扫码者昵称 [jifen] 奖励的积分 [jin_e] 奖励的钱 [couponname]优惠券名称 [couponnum] 优惠券张数 </span>-->
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">关注者通知</label>
		<div class="col-sm-10">
			<input type="text" name="tongzhi[guanzhuzhe]" class="form-control" value="{$hb['tongzhi']['guanzhuzhe']}">
			<span class="help-block">例如：您扫描了 [nicheng] 的二维码关注了公众号! 获得了 [jifen] 个积分,[jin_e]元奖励!</span>
			<!--<span class="help-block m-b-none">[nicheng] 为推荐者昵称 [jifen] 奖励的积分 [jin_e] 奖励的钱 [couponname]优惠券名称 [couponnum] 优惠券张数 </span>-->
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">关注者现金奖励入账描述</label>
		<div class="col-sm-10">
			<input type="text" name="tongzhi[guanzhuzhejiangliruzhangmiaoshu]" class="form-control" value="{$hb['tongzhi']['guanzhuzhejiangliruzhangmiaoshu']}">
			<span class="help-block">默认为：您通过 [nicheng]的推广二维码扫码关注的奖励</span>
			<span class="help-block m-b-none">[nicheng]为推荐者昵称</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label">推荐者现金奖励入账描述</label>
		<div class="col-sm-10">
			<input type="text" name="tongzhi[tuijianrenjiangliruzhangmiaoshu]" class="form-control" value="{$hb['tongzhi']['tuijianrenjiangliruzhangmiaoshu']}">
			<span class="help-block">默认为：推荐 [nicheng] 扫码关注的奖励</span>
			<span class="help-block m-b-none">[nicheng]为扫码者昵称</span>
		</div>
	</div>
	<div class="line line-dashed b-b line-lg "></div>
	<div class="form-group">
		<label class="col-sm-2 control-label"></label>
		<div class="col-sm-10">
			<button type="submit" class="btn btn-danger padder-lg">提交</button>
		</div>
	</div>
	<input type="hidden" name="data" />
</form>

<script language='javascript'>
	$('form').submit(function() {
		var data = [];
		$('.drag').each(function() {
			var obj = $(this);
			var type = obj.attr('type');
			var left = obj.css('left'),
				top = obj.css('top');
			var d = { left: left, top: top, type: obj.attr('type'), width: obj.css('width'), height: obj.css('height') };
			if(type == 'nickname' || type == 'title' || type == 'marketprice' || type == 'productprice') {
				d.size = obj.attr('size');
				d.color = obj.attr('color');
			} else if(type == 'qr') {
				d.size = obj.attr('size');
			} else if(type == 'img') {
				d.src = obj.attr('src');
			}
			data.push(d);
		});
		$(':input[name=data]').val(JSON.stringify(data));

		return true;
	});

	function bindEvents(obj) {

		var index = obj.attr('index');

		var rs = new Resize(obj, { Max: true, mxContainer: "#poster" });
		rs.Set($(".rRightDown", obj), "right-down");
		rs.Set($(".rLeftDown", obj), "left-down");
		rs.Set($(".rRightUp", obj), "right-up");
		rs.Set($(".rLeftUp", obj), "left-up");
		rs.Set($(".rRight", obj), "right");
		rs.Set($(".rLeft", obj), "left");
		rs.Set($(".rUp", obj), "up");
		rs.Set($(".rDown", obj), "down");
		rs.Scale = true;
		var type = obj.attr('type');
		if(type == 'nickname' || type == 'img' || type == 'title' || type == 'marketprice' || type == 'productprice') {
			rs.Scale = false;
		}
		new Drag(obj, { Limit: true, mxContainer: "#poster" });
		$('.drag .remove').unbind('click').click(function() {
			$(this).parent().remove();
		})

		$.getScript("/gongyong/js/haibao/jquery.contextMenu.js", function() {
			 	$.contextMenu({
				selector: '.drag[index=' + index + ']',
				callback: function(key, options) {
					var index = parseInt($(this).attr('zindex'));

					if(key == 'next') {
						var nextdiv = $(this).next('.drag');
						if(nextdiv.length > 0) {
							nextdiv.insertBefore($(this));
						}
					} else if(key == 'prev') {
						var prevdiv = $(this).prev('.drag');
						if(prevdiv.length > 0) {
							$(this).insertBefore(prevdiv);
						}
					} else if(key == 'last') {
						var len = $('.drag').length;
						if(index >= len - 1) {
							return;
						}
						var last = $('#poster .drag:last');
						if(last.length > 0) {
							$(this).insertAfter(last);
						}
					} else if(key == 'first') {
						var index = $(this).index();
						if(index <= 1) {
							return;
						}
						var first = $('#poster .drag:first');
						if(first.length > 0) {
							$(this).insertBefore(first);
						}
					} else if(key == 'delete') {
						$(this).remove();
					}
					var n = 1;
					$('.drag').each(function() {
						$(this).css("z-index", n);
						n++;
					})
				},
				items: {
					"next": { name: "调整到上层" },
					"prev": { name: "调整到下层" },
					"last": { name: "调整到最顶层" },
					"first": { name: "调整到最低层" },
					"delete": { name: "删除元素" }
				}
			});
		});

		
		obj.unbind('click').click(function() {
			bind($(this));
		})

	}
	var imgsettimer = 0;
	var nametimer = 0;
	var bgtimer = 0;

	function bindType(type) {
		$("#goodsparams").hide();
		$(".type4").hide();
		if(type == '4') {
			$(".type4").show();
		} else if(type == '3') {
			$("#goodsparams").show();
		}
	}

	function clearTimers() {
		clearInterval(imgsettimer);
		clearInterval(nametimer);
		clearInterval(bgtimer);

	}

	function getImgUrl(val) {        
		if(val.indexOf('http://') == -1) {			
			val = "{$_W['yuming']}/gongyong/shangchuan/" + val;
		}
		return val;
	}

	function bind(obj) {
		var imgset = $('#imgset'),
			nameset = $("#nameset"),
			qrset = $('#qrset');
		imgset.hide(), nameset.hide(), qrset.hide();
		clearTimers();
		var type = obj.attr('type');
		if(type == 'img') {
			imgset.show();
			var src = obj.attr('src');
			var input = imgset.find('input');
			var img = imgset.find('img');
			if(typeof(src) != 'undefined' && src != '') {
				input.val(src);
				img.attr('src', getImgUrl(src));
			}

			imgsettimer = setInterval(function() {
				if(input.val() != src && input.val() != '') {
					var url = getImgUrl(input.val());

					obj.attr('src', input.val()).find('img').attr('src', url);
				}
			}, 10);

		} else if(type == 'nickname' || type == 'title' || type == 'marketprice' || type == 'productprice') {

			nameset.show();
			var color = obj.attr('color') || "#000";
			var size = obj.attr('size') || "16";
			var input = nameset.find('input:first');
			var namesize = nameset.find('#namesize');
			var picker = nameset.find('.sp-preview-inner');
			input.val(color);
			namesize.val(size.replace("px", ""));
			picker.css({ 'background-color': color, 'font-size': size });

			nametimer = setInterval(function() {
				obj.attr('color', input.val()).find('.text').css('color', input.val());
				obj.attr('size', namesize.val() + "px").find('.text').css('font-size', namesize.val() + "px");
			}, 10);

		} else if(type == 'qr') {
			qrset.show();
			var size = obj.attr('size') || "3";
			var sel = qrset.find('#qrsize');
			sel.val(size);
			sel.unbind('change').change(function() {
				obj.attr('size', sel.val())
			});
		}
	}

	$(function() {

		$('.drag').each(function() {
			bindEvents($(this));
		})

		$(':radio[name=type]').click(function() {
			var type = $(this).val();
			bindType(type);
		})

		$(':radio[name=resptype]').click(function() {
			var type = $(this).val();
			if(type == 1) {
				$(".resptype1").show();
				$(".resptype0").hide();
			} else {
				$(".resptype0").show();
				$(".resptype1").hide();
			}
		})
		//改变背景
		$('#bgset').find('button:first').click(function() {

            var oldbg = $(':input[name=bg]').val();
			bgtimer = setInterval(function() {				
				var bg = $(':input[name=bg]').val();
				if(oldbg != bg) {
					bg = getImgUrl(bg);
					$('#poster .bg').remove();
					var bgh = $("<img src='" + bg + "' class='bg' />");
					var first = $('#poster .drag:first');
					if(first.length > 0) {
						bgh.insertBefore(first);
					} else {
						$('#poster').append(bgh);
					}

					oldbg = bg;
				}
			}, 10);
		})

		$('.btn-com').click(function() {

			var imgset = $('#imgset'),
				nameset = $("#nameset"),
				qrset = $('#qrset');
			imgset.hide(), nameset.hide(), qrset.hide();
			clearTimers();

			if($('#poster img').length <= 0) {
				//alert('请选择背景图片!');
				//return;
			}
			var type = $(this).data('type');
			var img = "";
			if(type == 'qr') {
				img = '<img src="{$_W["yuming"]}/gongyong/js/haibao/qr.jpg" />';
			} else if(type == 'head') {
				img = '<img src="{$_W["yuming"]}/gongyong/js/haibao/head.jpg" />';
			} else if(type == 'img' || type == 'thumb') {
				img = '<img src="{$_W["yuming"]}/gongyong/js/haibao/img.jpg" />';
			} else if(type == 'nickname') {
				img = '<div class=text>昵称</div>';
			} else if(type == 'title') {
				img = '<div class=text>商品名称</div>';
			} else if(type == 'marketprice') {
				img = '<div class=text>商品现价</div>';
			} else if(type == 'productprice') {
				img = '<div class=text>商品原价</div>';
			}
			var index = $('#poster .drag').length + 1;
			var obj = $('<div class="drag" type="' + type + '" index="' + index + '" style="z-index:' + index + '">' + img + '<div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div></div>');

			$('#poster').append(obj);

			bindEvents(obj);

		});

		$('.drag').click(function() {
			bind($(this));
		})

	})

	

	
</script>